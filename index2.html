<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç§äººæ—¥è®°æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #fdfcf8; color: #4a4a4a; font-family: 'Noto Serif SC', serif; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-2xl mx-auto">
        <header class="mb-10 text-center">
            <h1 class="text-3xl font-bold text-gray-800">ğŸ–‹ï¸ å²æœˆç•™ç—•</h1>
            <p class="text-gray-500 mt-2">éšæ—¶éšåœ°ï¼Œè®°å½•æ­¤æ—¶æ­¤åˆ»</p>
        </header>

        <div class="glass p-6 rounded-2xl shadow-sm border border-gray-100 mb-8">
            <textarea id="diaryInput" rows="5" class="w-full bg-transparent border-none focus:outline-none text-lg resize-none" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆæœ‰è¶£çš„æ—¶åˆ»..."></textarea>
            <div class="flex justify-end mt-4">
                <button onclick="saveDiary()" class="bg-gray-800 text-white px-6 py-2 rounded-full hover:bg-black transition shadow-md">ä¿å­˜åˆ°äº‘ç«¯</button>
            </div>
        </div>

        <div id="diaryList" class="space-y-6">
            <p class="text-center text-gray-400">æ­£åœ¨åŒæ­¥äº‘ç«¯ç¬”è®°...</p>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯ï¼ˆè¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ä¿¡æ¯ï¼‰
        const GITHUB_CONFIG = {
            token: 'ä½ çš„_GITHUB_TOKEN', // âš ï¸ æ³¨æ„ï¼šå‰ç«¯æš´éœ² token æœ‰é£é™©ï¼Œå»ºè®®è®¾ä¸ºç§äººä»“åº“
            repo: 'ä½ çš„ç”¨æˆ·å/ä»“åº“å',
            path: 'articles.json'
        };

        let articles = [];

        // 1. åˆå§‹åŒ–ï¼šä»ä»“åº“è¯»å– articles.json
        async function fetchDiaries() {
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`);
                const data = await res.json();
                const content = decodeURIComponent(escape(atob(data.content))); // å¤„ç†ä¸­æ–‡ä¹±ç 
                articles = JSON.parse(content);
                renderDiaries();
                return data.sha; // ä¿å­˜æ–‡ä»¶çš„ SHA ä¾›åç»­æ›´æ–°ä½¿ç”¨
            } catch (e) {
                console.error("åŠ è½½å¤±è´¥", e);
            }
        }

        // 2. æ¸²æŸ“åˆ—è¡¨
        function renderDiaries() {
            const list = document.getElementById('diaryList');
            list.innerHTML = articles.map(item => `
                <div class="border-l-2 border-gray-200 pl-4 py-2">
                    <div class="text-xs text-gray-400 mb-1">${item.date}</div>
                    <div class="text-gray-700 leading-relaxed">${item.content}</div>
                </div>
            `).reverse().join('');
        }

        // 3. ä¿å­˜é€»è¾‘ï¼šæ¨é€åˆ° GitHub
        async function saveDiary() {
            const content = document.getElementById('diaryInput').value;
            if(!content) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");

            const newItem = {
                date: new Date().toLocaleString(),
                content: content
            };

            // è·å–æ—§æ–‡ä»¶çš„ SHA
            const getRes = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`);
            const getData = await getRes.json();
            const sha = getData.sha;

            articles.push(newItem);
            const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(articles, null, 2))));

            const putRes = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Add diary: ${newItem.date}`,
                    content: updatedContent,
                    sha: sha
                })
            });

            if(putRes.ok) {
                document.getElementById('diaryInput').value = '';
                renderDiaries();
                alert("åŒæ­¥æˆåŠŸï¼");
            }
        }

        window.onload = fetchDiaries;
    </script>
</body>
</html>
