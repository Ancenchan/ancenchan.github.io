// 1. 修复GitHub API调用，添加更好的错误处理
async function fetchArticlesFromGitHub() {
    if (!gitHubManager.isConfigured()) {
        console.log('GitHub未配置，使用本地存储');
        const localArticles = JSON.parse(localStorage.getItem('fuwakoArticles') || '[]');
        return checkAndFixData(localArticles);
    }

    try {
        console.log('正在从GitHub获取文章...', {
            owner: gitHubManager.repoOwner,
            repo: gitHubManager.repoName,
            branch: gitHubManager.repoBranch,
            path: gitHubManager.dataPath
        });

        // 首先检查仓库是否存在
        const repoCheck = await fetch(
            `${gitHubManager.apiBase}/repos/${gitHubManager.repoOwner}/${gitHubManager.repoName}`,
            {
                headers: {
                    'Authorization': gitHubManager.token ? `token ${gitHubManager.token}` : '',
                    'Accept': 'application/vnd.github.v3+json'
                }
            }
        );

        if (!repoCheck.ok) {
            if (repoCheck.status === 404) {
                showNotification('仓库不存在，请检查配置', 'error');
                return JSON.parse(localStorage.getItem('fuwakoArticles') || '[]');
            }
            if (repoCheck.status === 401) {
                showNotification('GitHub Token无效或已过期', 'error');
                return JSON.parse(localStorage.getItem('fuwakoArticles') || '[]');
            }
            throw new Error(`仓库检查失败: ${repoCheck.status}`);
        }

        // 获取文件内容
        const response = await fetch(
            `${gitHubManager.apiBase}/repos/${gitHubManager.repoOwner}/${gitHubManager.repoName}/contents/${gitHubManager.dataPath}?ref=${gitHubManager.repoBranch}`,
            {
                headers: {
                    'Authorization': gitHubManager.token ? `token ${gitHubManager.token}` : '',
                    'Accept': 'application/vnd.github.v3+json'
                }
            }
        );

        if (response.status === 404) {
            console.log('文章文件不存在，将创建新文件');
            // 尝试创建一个初始文件
            await gitHubManager.saveArticles([]);
            return [];
        }

        if (!response.ok) {
            const errorText = await response.text();
            console.error('GitHub API错误:', response.status, errorText);
            
            if (response.status === 403) {
                showNotification('GitHub API限制或权限不足', 'error');
            }
            
            return JSON.parse(localStorage.getItem('fuwakoArticles') || '[]');
        }

        const fileData = await response.json();
        
        if (!fileData.content) {
            throw new Error('文件内容为空');
        }

        // 清理Base64内容
        let cleanedContent = fileData.content.replace(/\s/g, '');
        
        // 尝试解码
        let decodedContent;
        try {
            decodedContent = safeBase64Decode(cleanedContent);
        } catch (decodeError) {
            console.error('Base64解码失败:', decodeError);
            // 尝试直接解析
            try {
                const binaryStr = atob(cleanedContent);
                decodedContent = decodeURIComponent(escape(binaryStr));
            } catch (e) {
                console.error('降级解码也失败:', e);
                decodedContent = '';
            }
        }

        let articles;
        try {
            articles = JSON.parse(decodedContent || '[]');
            console.log('成功从GitHub获取文章:', articles.length, '篇');
        } catch (parseError) {
            console.error('JSON解析失败:', parseError);
            
            // 尝试修复JSON
            try {
                // 移除可能的非法字符
                const fixedContent = decodedContent
                    .replace(/[\x00-\x1F\x7F-\x9F]/g, '')
                    .replace(/[\u201C\u201D]/g, '"')
                    .replace(/[\u2018\u2019]/g, "'");
                
                articles = JSON.parse(fixedContent);
            } catch (fixError) {
                console.error('JSON修复也失败:', fixError);
                
                // 尝试逐行解析
                const lines = decodedContent.split('\n');
                const validLines = lines.filter(line => {
                    try {
                        JSON.parse(line);
                        return true;
                    } catch {
                        return false;
                    }
                });
                
                if (validLines.length > 0) {
                    articles = validLines.map(line => JSON.parse(line));
                } else {
                    articles = [];
                }
            }
        }

        // 修复数据格式
        const fixedArticles = checkAndFixData(articles);
        
        // 保存到本地存储作为备份
        localStorage.setItem('fuwakoArticles', JSON.stringify(fixedArticles));
        
        return fixedArticles;
        
    } catch (error) {
        console.error('从GitHub获取文章失败：', error);
        showNotification(`获取失败: ${error.message}，使用本地缓存`, 'warning');
        
        // 返回本地存储的数据
        return JSON.parse(localStorage.getItem('fuwakoArticles') || '[]');
    }
}

// 2. 更新GitHubManager类中的fetchArticles方法
class GitHubManager {
    // ... 其他方法保持不变 ...

    async fetchArticles() {
        return await fetchArticlesFromGitHub();
    }

    // 添加调试信息显示
    showDebugInfo() {
        console.group('GitHub配置状态');
        console.log('是否配置:', this.isConfigured());
        console.log('Token长度:', this.token ? this.token.length : 0);
        console.log('仓库所有者:', this.repoOwner);
        console.log('仓库名称:', this.repoName);
        console.log('分支:', this.repoBranch);
        console.groupEnd();
    }
}

// 3. 增强GitHub配置检测
function updateGitHubUI() {
    const syncBtn = document.getElementById('syncBtn');
    const configBtn = document.getElementById('configBtn');
    const footerStatus = document.getElementById('githubStatusFooter');
    
    if (gitHubManager.isConfigured()) {
        syncBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> 同步';
        syncBtn.title = '同步文章到GitHub';
        configBtn.innerHTML = '<i class="fab fa-github"></i> 已配置';
        configBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
        footerStatus.innerHTML = `<i class="fas fa-cloud"></i> GitHub同步：已配置 (${gitHubManager.repoOwner}/${gitHubManager.repoName})`;
        footerStatus.style.color = '#4CAF50';
    } else {
        syncBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> 同步';
        syncBtn.title = '请先配置GitHub';
        configBtn.innerHTML = '<i class="fab fa-github"></i> 配置';
        configBtn.style.background = 'linear-gradient(135deg, #333, #555)';
        footerStatus.innerHTML = '<i class="fas fa-cloud"></i> GitHub同步：未配置';
        footerStatus.style.color = '#888';
    }
}

// 4. 添加调试按钮（可选）
function addDebugButton() {
    const debugBtn = document.createElement('button');
    debugBtn.innerHTML = '<i class="fas fa-bug"></i> 调试';
    debugBtn.style.cssText = 'position: fixed; bottom: 180px; right: 30px; background: #666; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; z-index: 99; cursor: pointer; border: none;';
    
    debugBtn.addEventListener('click', function() {
        gitHubManager.showDebugInfo();
        showNotification('调试信息已输出到控制台', 'info');
    });
    
    document.body.appendChild(debugBtn);
}

// 5. 页面加载时添加调试按钮
window.addEventListener('DOMContentLoaded', function() {
    // ... 其他初始化代码 ...
    
    // 添加调试按钮
    addDebugButton();
    
    // 显示GitHub配置状态
    if (gitHubManager.isConfigured()) {
        showNotification('GitHub已配置，正在检查连接...', 'info');
        
        // 测试连接
        setTimeout(async () => {
            try {
                const result = await gitHubManager.testConnection();
                showNotification(result.message, 'success');
            } catch (error) {
                showNotification(`GitHub连接失败: ${error.message}`, 'error');
            }
        }, 1000);
    }
});

// 6. 增强测试连接功能
async function testGitHubConnection() {
    const token = document.getElementById('githubToken').value.trim();
    const owner = document.getElementById('repoOwner').value.trim();
    const name = document.getElementById('repoName').value.trim();
    const branch = document.getElementById('repoBranch').value.trim() || 'main';
    
    if (!token) {
        showNotification('请填写GitHub Token！', 'warning');
        return;
    }
    if (!owner) {
        showNotification('请填写仓库所有者用户名！', 'warning');
        return;
    }
    if (!name) {
        showNotification('请填写仓库名称！', 'warning');
        return;
    }
    
    gitHubManager.saveConfig(token, owner, name, branch);
    
    showNotification('正在测试连接...', 'info');
    
    try {
        const result = await gitHubManager.testConnection();
        showNotification(result.message, 'success');
        
        // 测试获取文章
        const articles = await gitHubManager.fetchArticles();
        showNotification(`连接成功！获取到 ${articles.length} 篇文章`, 'success');
        
        gitHubManager.showConfigStatus();
    } catch (error) {
        showNotification(`测试失败：${error.message}`, 'error');
    }
}
