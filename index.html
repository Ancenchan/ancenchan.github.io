<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notebook | 岁月留痕</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root { --fuwari-bg: #f4f7f6; --fuwari-card: #ffffff; --fuwari-accent: #88abaf; --fuwari-delete: #e5a4a4; }
        body { background-color: var(--fuwari-bg); font-family: 'Noto Sans SC', sans-serif; color: #444; scroll-behavior: smooth; }
        .fuwari-card { 
            background: var(--fuwari-card); 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            transition: all 0.3s ease;
        }
        .fuwari-card:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(0,0,0,0.06); }
        .btn-primary { background: var(--fuwari-accent); color: white; }
        .input-focus:focus { outline: none; box-shadow: 0 2px 10px rgba(136, 171, 175, 0.2); }
        .action-btn { opacity: 0; transition: opacity 0.2s; }
        .fuwari-card:hover .action-btn { opacity: 1; }
    </style>
</head>
<body class="py-12 px-4">
    <div class="max-w-2xl mx-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-light tracking-tight text-gray-800">My Diary</h1>
                <p id="statusInfo" class="text-xs text-gray-400 mt-1">云端同步已就绪</p>
            </div>
            <button onclick="configToken()" class="text-xs bg-white px-3 py-1 rounded-full shadow-sm text-gray-400 hover:text-gray-600 transition">配置 Token</button>
        </header>

        <div class="fuwari-card p-6 mb-12 border border-white">
            <h2 id="editorTitle" class="text-sm font-medium text-gray-400 mb-4 uppercase tracking-widest">撰写新章节</h2>
            <textarea id="diaryInput" rows="5" 
                class="w-full border-none focus:ring-0 text-gray-600 placeholder-gray-300 resize-none text-lg input-focus rounded-lg p-2" 
                placeholder="记录此时此刻..."></textarea>
            <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-gray-50">
                <button id="cancelEditBtn" onclick="resetEditor()" class="hidden text-gray-400 text-sm px-4">取消修改</button>
                <button onclick="handleSave()" id="saveBtn" class="btn-primary px-8 py-2 rounded-xl text-sm font-medium shadow-md active:scale-95 transition">
                    保存到云端
                </button>
            </div>
        </div>

        <div id="diaryList" class="space-y-8">
            <div class="text-center py-20 text-gray-300">正在检索云端数据...</div>
        </div>
    </div>

    <script>
        // --- 请务必修改此处 ---
        const REPO = "你的用户名/仓库名"; 
        const PATH = "articles.json";
        
        let diaryData = [];
        let currentSha = "";
        let editingId = null; // 用于记录当前正在编辑哪一条

        function getToken() { return localStorage.getItem('gh_token'); }
        function configToken() {
            const t = prompt("请输入 GitHub Personal Access Token (需 repo 权限):");
            if(t) { localStorage.setItem('gh_token', t); location.reload(); }
        }

        // 1. 查 (Read)
        async function fetchCloudData() {
            if(!getToken()) {
                document.getElementById('diaryList').innerHTML = `<div class="text-center py-10 text-gray-400 font-light">请点击右上角配置 Token</div>`;
                return;
            }
            try {
                const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}`, {
                    headers: { 'Authorization': `token ${getToken()}`, 'Cache-Control': 'no-cache' }
                });
                if (res.ok) {
                    const data = await res.json();
                    currentSha = data.sha;
                    const content = decodeURIComponent(atob(data.content).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                    diaryData = JSON.parse(content);
                    render();
                } else {
                    diaryData = [];
                    render();
                }
            } catch (e) {
                console.error(e);
                document.getElementById('diaryList').innerHTML = "加载失败，请检查配置。";
            }
        }

        // 渲染方法
        function render() {
            const list = document.getElementById('diaryList');
            if(diaryData.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-gray-300 font-light italic">这里空空如也，开始写第一篇吧</div>`;
                return;
            }
            list.innerHTML = diaryData.slice().reverse().map((item, index) => {
                const realIndex = diaryData.length - 1 - index;
                return `
                <div class="fuwari-card p-8 group">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-[10px] uppercase tracking-[0.2em] text-gray-300">${item.date}</span>
                        <div class="action-btn flex gap-3">
                            <button onclick="startEdit(${realIndex})" class="text-xs text-blue-300 hover:text-blue-500">编辑</button>
                            <button onclick="deleteItem(${realIndex})" class="text-xs text-red-200 hover:text-red-400">删除</button>
                        </div>
                    </div>
                    <div class="text-gray-600 leading-relaxed font-light text-lg whitespace-pre-wrap">${item.content}</div>
                </div>
                `;
            }).join('');
        }

        // 2. 增 & 改 (Create & Update)
        async function handleSave() {
            const input = document.getElementById('diaryInput');
            const btn = document.getElementById('saveBtn');
            if(!input.value.trim()) return;

            btn.disabled = true;
            btn.innerText = "同步中...";

            if (editingId !== null) {
                // 修改逻辑
                diaryData[editingId].content = input.value;
                diaryData[editingId].date = new Date().toLocaleString() + " (已编辑)";
            } else {
                // 新增逻辑
                diaryData.push({
                    date: new Date().toLocaleString(),
                    content: input.value
                });
            }

            const success = await syncToCloud();
            if(success) {
                input.value = '';
                resetEditor();
                render();
            }
            btn.disabled = false;
            btn.innerText = "保存到云端";
        }

        // 3. 删 (Delete)
        async function deleteItem(index) {
            if(!confirm("确定要删除这段记忆吗？")) return;
            diaryData.splice(index, 1);
            await syncToCloud();
            render();
        }

        // 进入编辑模式
        function startEdit(index) {
            editingId = index;
            document.getElementById('diaryInput').value = diaryData[index].content;
            document.getElementById('editorTitle').innerText = "修改章节";
            document.getElementById('saveBtn').innerText = "确认修改";
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function resetEditor() {
            editingId = null;
            document.getElementById('diaryInput').value = '';
            document.getElementById('editorTitle').innerText = "撰写新章节";
            document.getElementById('saveBtn').innerText = "保存到云端";
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        // 核心：同步到 GitHub
        async function syncToCloud() {
            const jsonString = JSON.stringify(diaryData, null, 2);
            const base64Content = btoa(unescape(encodeURIComponent(jsonString)));

            try {
                const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${getToken()}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Diary auto-sync",
                        content: base64Content,
                        sha: currentSha
                    })
                });
                const resData = await res.json();
                if(res.ok) {
                    currentSha = resData.content.sha;
                    return true;
                } else {
                    alert("同步失败：" + resData.message);
                    return false;
                }
            } catch (e) {
                alert("网络错误");
                return false;
            }
        }

        window.onload = fetchCloudData;
    </script>
</body>
</html>
